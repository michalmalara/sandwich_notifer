{% load static from staticfiles %}
<html>
	<head>
		<title>Dostawcy jedzenia</title>
		<link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%}">
		<link rel="stylesheet" type="text/css" href="{% static 'css/style1.css' %}">
		<script src="{% static '/js/websocketbridge.js' %}" type="text/javascript"></script>
		<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script>
			jQuery(document).ready(function($){
			  op = function(obj) {
				$(obj).stop().slideToggle();
				};
			});
		</script>

		<script>

			var alertSound = new Audio("{%static '/sound/alert.wav'%}")

		</script>
		
		
		
	</head>
	<body style="background-image: url({% static 'img/background7.jpeg'%}) ;">
		<div id='PAGE' style="background-image: url({% static 'img/background.png' %})">
			<div id="NAV">
				{% if user.is_authenticated %}
					{{user.username}} | <a href='/logout/'>Wyloguj</a> | <a href='/report_visit/'>Zgłoś wizytę</a> | 
					{% if user.is_superuser%}
						<a href="/admin/">Panel administracyny</a> | 
					{%endif%}
				{% else %}
					| <a href='/login/'>Zaloguj</a> |
				{% endif %}
				
			</div>
			<div id='HEADER'>
				
				<div id='HEADER_CONTENT'>
					Dostawcy jedzenia
				</div>
			</div>
			
			<div id='MAIN'>				
				{% for provider in providers %}
					<div class='PROVIDER' onClick="op('#hidden_{{provider.shortcut}}');" id='{{provider.shortcut}}' style="background-image: url({% static 'img/background_prov.png' %});">
						<div class='prov_main'>
							<div class='logo'>
								<figure><img src="{{provider.logo}}" alt='{{ provider.name }}' /></figure>
								<figcaption>{{provider.name}}</figcaption>
							</div>
							
							<div class='last_time' id="latstime_{{provider.shortcut}}">							
								{{provider.last_visit.dateOfVisit|date:"d.m.y, H:i"}} - 
								{% if provider.last_visit.floor == 0 %}
									parter
								{% else %}
									{{provider.last_visit.floor}} piętro
								{% endif %}
							</div>
						</div>
						Poprzednie wizyty					
						<div id="hidden_{{provider.shortcut}}" style="display: none;">
							<div class='other_dates' id = "otherdates_{{provider.shortcut}}">
								<list id="datelist_{{provider.shortcut}}">
									{% for visit in provider.visits %}
										<li>{{visit.dateOfVisit|date:"d.m.y, H:i"}} - 
										{% if visit.floor == 0 %}
												parter 
											{% else %}
												{{visit.floor}} piętro 
										{% endif %}
										</li>
									{% endfor %}
								</list>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
		<ul id="notifylist"></ul>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
		<script src="{% static 'js/bootstrap.min.js'%}"></script>
		<!--Websockets handling script-->
		<script>
			document.addEventListener('DOMContentLoaded', function() {
			  const webSocketBridge = new channels.WebSocketBridge();
			  const nl = document.querySelector("#notifylist");

			  webSocketBridge.connect('/ws/');
			  webSocketBridge.listen(function(action, stream) {
					//console.log("RESPONSE:", action);
						if(action.event == "New Visit") {
							//copy last visit to previous visits
							var prev_visits = document.getElementById(`datelist_${action.provider}`).innerHTML;
							var last_visit = document.getElementById(`latstime_${action.provider}`).innerHTML;
							document.getElementById(`datelist_${action.provider}`).innerHTML = `<li> ${last_visit}</li>${prev_visits}`;
							//put new visit in last visit
							if(action.floor>0){
								document.getElementById(`latstime_${action.provider}`).innerHTML = `${action.date_and_time} - ${action.floor} piętro`;
								document.title=`${action.providerName} czeka na ${action.floor} piętrze!`
							} else {
								document.getElementById(`latstime_${action.provider}`).innerHTML = `${action.date_and_time} - parter`;
								document.title=`${action.providerName} czeka na parterze!`
							}
							//play sound
							alertSound.play()
						}
				  })
			  document.ws = webSocketBridge; /* for debugging */
			})
		</script>
	</body>
</html>
